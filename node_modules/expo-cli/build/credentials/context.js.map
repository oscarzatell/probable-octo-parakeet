{"version":3,"sources":["../../src/credentials/context.ts"],"names":["Context","user","_user","hasProjectContext","_hasProjectContext","manifest","_manifest","Error","api","_apiClient","ios","_iosApiClient","appleCtx","_appleCtx","value","hasAppleCtx","ensureAppleCtx","options","init","projectDir","allowAnonymous","UserManager","getCurrentUserAsync","undefined","ensureLoggedInAsync","status","Doctor","validateWithoutNetworkAsync","FATAL","exp","IosApi","withProjectContext","owner","username","slug","ApiV2","clientForUser"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;AAeO,MAAMA,OAAN,CAAc;AAAA;AAAA,gDACW,KADX;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;AAAA;;AAQnB,MAAIC,IAAJ,GAAiB;AACf,WAAO,KAAKC,KAAZ;AACD;;AACD,MAAIC,iBAAJ,GAAiC;AAC/B,WAAO,KAAKC,kBAAZ;AACD;;AACD,MAAIC,QAAJ,GAA2B;AACzB,QAAI,CAAC,KAAKC,SAAV,EAAqB;AACnB,YAAM,IAAIC,KAAJ,CAAU,sCAAV,CAAN;AACD;;AACD,WAAO,KAAKD,SAAZ;AACD;;AACD,MAAIE,GAAJ,GAAiB;AACf,WAAO,KAAKC,UAAZ;AACD;;AACD,MAAIC,GAAJ,GAAkB;AAChB,WAAO,KAAKC,aAAZ;AACD;;AACD,MAAIC,QAAJ,GAAyB;AACvB,QAAI,CAAC,KAAKC,SAAV,EAAqB;AACnB,YAAM,IAAIN,KAAJ,CAAU,gCAAV,CAAN;AACD;;AACD,WAAO,KAAKM,SAAZ;AACD;;AACD,MAAIR,QAAJ,CAAaS,KAAb,EAAgC;AAC9B,SAAKR,SAAL,GAAiBQ,KAAjB;AACD;;AAEDC,EAAAA,WAAW,GAAY;AACrB,WAAO,CAAC,CAAC,KAAKF,SAAd;AACD;;AAED,QAAMG,cAAN,CAAqBC,OAAwB,GAAG,EAAhD,EAAoD;AAClD,QAAI,CAAC,KAAKJ,SAAV,EAAqB;AACnB,WAAKA,SAAL,GAAiB,MAAM,8BAAaI,OAAb,CAAvB;AACD;AACF;;AAED,QAAMC,IAAN,CAAWC,UAAX,EAA+BF,OAAmB,GAAG,EAArD,EAAyD;AACvD,QAAIA,OAAO,CAACG,cAAZ,EAA4B;AAC1B,WAAKlB,KAAL,GAAa,CAAC,MAAMmB,mBAAYC,mBAAZ,EAAP,KAA6CC,SAA1D;AACD,KAFD,MAEO;AACL,WAAKrB,KAAL,GAAa,MAAMmB,mBAAYG,mBAAZ,EAAnB;AACD,KALsD,CAOvD;;;AACA,UAAMC,MAAM,GAAG,MAAMC,cAAOC,2BAAP,CAAmCR,UAAnC,CAArB;;AACA,QAAIM,MAAM,KAAKC,cAAOE,KAAtB,EAA6B;AAAA;;AAC3B,YAAM;AAAEC,QAAAA;AAAF,UAAU,yBAAUV,UAAV,CAAhB;AACA,WAAKb,SAAL,GAAiBuB,GAAjB;AACA,WAAKzB,kBAAL,GAA0B,IAA1B;AACA,WAAKO,aAAL,GAAqB,KAAImB,aAAJ,EAAW,KAAK7B,IAAhB,EAAsB8B,kBAAtB,CAAyC,IAAzC,CAArB;AACA,0BACG,+BAAD,wBAA+B,KAAK1B,QAAL,CAAc2B,KAA7C,uEAAsD,KAAK/B,IAAL,CAAUgC,QAAS,eACvE,KAAK5B,QAAL,CAAc6B,IACf,EAHH;AAKD,KAVD,MAUO;AACL;AACA,WAAKvB,aAAL,GAAqB,KAAImB,aAAJ,EAAW,KAAK7B,IAAhB,CAArB;AACD;;AAED,SAAKQ,UAAL,GAAkB0B,aAAMC,aAAN,CAAoB,KAAKnC,IAAzB,CAAlB;AACD;;AAvEkB","sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport { ApiV2, Doctor, User, UserManager } from '@expo/xdl';\n\nimport { AppleCtx, authenticate } from '../appleApi';\nimport { IosApi } from './api';\nimport log from '../log';\n\nexport interface IView {\n  open(ctx: Context): Promise<IView | null>;\n}\n\ntype AppleCtxOptions = {\n  appleId?: string;\n  appleIdPassword?: string;\n};\n\ntype CtxOptions = {\n  allowAnonymous?: boolean;\n};\n\nexport class Context {\n  _hasProjectContext: boolean = false;\n  _user?: User;\n  _manifest?: ExpoConfig;\n  _apiClient?: ApiV2;\n  _iosApiClient?: IosApi;\n  _appleCtx?: AppleCtx;\n\n  get user(): User {\n    return this._user as User;\n  }\n  get hasProjectContext(): boolean {\n    return this._hasProjectContext;\n  }\n  get manifest(): ExpoConfig {\n    if (!this._manifest) {\n      throw new Error('Manifest (app.json) not initialized.');\n    }\n    return this._manifest;\n  }\n  get api(): ApiV2 {\n    return this._apiClient as ApiV2;\n  }\n  get ios(): IosApi {\n    return this._iosApiClient as IosApi;\n  }\n  get appleCtx(): AppleCtx {\n    if (!this._appleCtx) {\n      throw new Error('Apple context not initialized.');\n    }\n    return this._appleCtx;\n  }\n  set manifest(value: ExpoConfig) {\n    this._manifest = value;\n  }\n\n  hasAppleCtx(): boolean {\n    return !!this._appleCtx;\n  }\n\n  async ensureAppleCtx(options: AppleCtxOptions = {}) {\n    if (!this._appleCtx) {\n      this._appleCtx = await authenticate(options);\n    }\n  }\n\n  async init(projectDir: string, options: CtxOptions = {}) {\n    if (options.allowAnonymous) {\n      this._user = (await UserManager.getCurrentUserAsync()) || undefined;\n    } else {\n      this._user = await UserManager.ensureLoggedInAsync();\n    }\n\n    // Check if we are in project context by looking for a manifest\n    const status = await Doctor.validateWithoutNetworkAsync(projectDir);\n    if (status !== Doctor.FATAL) {\n      const { exp } = getConfig(projectDir);\n      this._manifest = exp;\n      this._hasProjectContext = true;\n      this._iosApiClient = new IosApi(this.user).withProjectContext(this);\n      log(\n        `Configuring credentials for ${this.manifest.owner ?? this.user.username} in project ${\n          this.manifest.slug\n        }`\n      );\n    } else {\n      /* This manager does not need to work in project context */\n      this._iosApiClient = new IosApi(this.user);\n    }\n\n    this._apiClient = ApiV2.clientForUser(this.user);\n  }\n}\n"],"file":"context.js"}